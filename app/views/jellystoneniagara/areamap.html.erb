<div id="mappage">

  <div id="googleMap"><!--[if lt IE 9]><img src="/images/attractions/iemapfinished.png"><![endif]--></div>
    
  <div id="legend">
    <p id="legendnotice">Click on a color to see it on the map!</p><br/>
    <% @mapAttractions.each do |attraction| %>
      <div class="legendcolorbox" style="background-color:#<%= attraction[:color] %>;"></div><p class="legendtext"><%= attraction[:name] %></p>
    <% end %>
  </div>

  <div id="belowmap">
    <h2>Click on a marker to see more information!</h2>
    <div id="attractioncontent" class="wood"></div>
  </div>

</div>

<script>
function initialize()
{
var mapProp = {
  center:new google.maps.LatLng(43.089639,-79.085011),
  zoom:12,
  mapTypeId:google.maps.MapTypeId.ROADMAP,
};

var map = new google.maps.Map(document.getElementById("googleMap"),mapProp);

markers = new Array();
var pos = 0;

var infowindow = new google.maps.InfoWindow({content: "blank"});
<% @mapAttractions.each do |attraction| %>
  <% if attraction.latitude != nil && attraction.longitude != nil %>
    var marker = new StyledMarker({
      styleIcon: new StyledIcon(StyledIconTypes.MARKER,{color:"<%= attraction[:color] %>",/* text:"<%= attraction[:marker_label] %>" */}),
      position: new google.maps.LatLng(<%= attraction[:latitude] %>, <%= attraction[:longitude] %>),
      map: map,
      title: "<%= attraction[:name] %>",
      animation: google.maps.Animation.DROP,
      id: <%= attraction[:id] %>
      <% infoheader = '<p>' + attraction.name + '</p>' %>
      <% if attraction.content != nil && attraction.content.link != nil %>
      <% infoheader = "<a target='_blank' href='" + attraction.content.link + "'>" + infoheader + "</a>" %>
      <% end %>
    }); 
    markers[pos++] = marker;
    google.maps.event.addListener(marker,"click",function(){
      infowindow.close();
      infowindow.setContent("<%= infoheader.html_safe %>");
      infowindow.setOptions({maxWidth: "500"});
      $("#attractioncontent").load("getAttraction?id=" + this.id);
      infowindow.open(map,this);
    });
    $(marker).click(function(){
      infowindow.close();
      infowindow.setContent("<%= infoheader.html_safe %>");
      infowindow.setOptions({maxWidth: "500"});
      $("#attractioncontent").load("getAttraction?id=" + this.id);
      $(".content")
      infowindow.open(map,this);
    });
  <% end %>
<% end %>

var marker = new google.maps.Marker({
    position: new google.maps.LatLng(43.157851,-79.101959),
    title: "North to Niagara-on-the-Lake",
    icon: {
      path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
      scale: 10
    },
    map: map
  });
}

$(".legendcolorbox").click(function() {
  temp = this;
  markers.forEach(function(entry){
    if (entry.title == $(temp).next().text()) {
      $(entry).click();
    }
  });
});

google.maps.event.addDomListener(window, 'load', initialize);
</script>